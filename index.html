import React, { useState, useEffect, useRef } from 'react';
import { BookOpen, Home, Plus, ZoomIn, ZoomOut, ChevronLeft, ChevronRight, Menu, X, Upload } from 'lucide-react';

const PDFReaderApp = () => {
  const [view, setView] = useState('home');
  const [pdfUrl, setPdfUrl] = useState('');
  const [savedPDFs, setSavedPDFs] = useState([]);
  const [currentPDF, setCurrentPDF] = useState(null);
  const [currentPage, setCurrentPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [zoom, setZoom] = useState(1);
  const [isFlipping, setIsFlipping] = useState(false);
  const [flipDirection, setFlipDirection] = useState('');
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [loading, setLoading] = useState(false);
  const canvasRef = useRef(null);
  const pdfDocRef = useRef(null);
  const fileInputRef = useRef(null);

  useEffect(() => {
    const stored = JSON.parse(localStorage.getItem('pdfLibrary') || '[]');
    setSavedPDFs(stored);
  }, []);

  const playPageFlipSound = () => {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.1);
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.15);
    } catch(e) {
      console.log('Audio not supported');
    }
  };

  const extractFileId = (url) => {
    const patterns = [
      /\/file\/d\/([a-zA-Z0-9_-]+)/,
      /id=([a-zA-Z0-9_-]+)/,
      /\/d\/([a-zA-Z0-9_-]+)/
    ];
    
    for (const pattern of patterns) {
      const match = url.match(pattern);
      if (match) return match[1];
    }
    return null;
  };

  const handleFileUpload = async (event) => {
    const file = event.target.files[0];
    if (!file || file.type !== 'application/pdf') {
      alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø PDF ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
      return;
    }

    const reader = new FileReader();
    reader.onload = async (e) => {
      await loadPDFFromData(e.target.result, file.name);
    };
    reader.readAsDataURL(file);
  };

  const loadPDFFromData = async (dataUrl, fileName) => {
    try {
      setLoading(true);
      const pdfjsLib = window['pdfjs-dist/build/pdf'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      
      const loadingTask = pdfjsLib.getDocument(dataUrl);
      const pdf = await loadingTask.promise;
      pdfDocRef.current = pdf;
      setTotalPages(pdf.numPages);
      setCurrentPage(1);
      await renderPage(1, pdf);
      
      const newPDF = {
        id: Date.now(),
        data: dataUrl,
        title: fileName || `PDF ${savedPDFs.length + 1}`,
        addedDate: new Date().toISOString(),
        isLocal: true
      };
      
      const updatedPDFs = [...savedPDFs, newPDF];
      setSavedPDFs(updatedPDFs);
      localStorage.setItem('pdfLibrary', JSON.stringify(updatedPDFs));
      setCurrentPDF(newPDF);
      setView('reader');
      setLoading(false);
    } catch (error) {
      setLoading(false);
      alert('PDF ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
      console.error(error);
    }
  };

  const loadPDF = async (url) => {
    try {
      setLoading(true);
      let pdfData = url;
      
      // Check if it's a Google Drive link
      if (url.includes('drive.google.com')) {
        const fileId = extractFileId(url);
        if (fileId) {
          // Use direct download link
          pdfData = `https://drive.google.com/uc?export=download&id=${fileId}`;
        }
      }

      const pdfjsLib = window['pdfjs-dist/build/pdf'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      
      const loadingTask = pdfjsLib.getDocument({ url: pdfData, withCredentials: false });
      const pdf = await loadingTask.promise;
      pdfDocRef.current = pdf;
      setTotalPages(pdf.numPages);
      setCurrentPage(1);
      await renderPage(1, pdf);
      
      const existingPDF = savedPDFs.find(p => p.url === url);
      
      if (!existingPDF) {
        const newPDF = {
          id: Date.now(),
          url: url,
          title: `PDF ${savedPDFs.length + 1}`,
          addedDate: new Date().toISOString(),
        };
        
        const updatedPDFs = [...savedPDFs, newPDF];
        setSavedPDFs(updatedPDFs);
        localStorage.setItem('pdfLibrary', JSON.stringify(updatedPDFs));
        setCurrentPDF(newPDF);
      } else {
        setCurrentPDF(existingPDF);
      }
      
      setView('reader');
      setLoading(false);
    } catch (error) {
      setLoading(false);
      alert('PDF ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§\n\n‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®:\n‡ßß. Google Drive ‡¶π‡¶≤‡ßá ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®\n‡ß®. ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (üì§)');
      console.error(error);
    }
  };

  const renderPage = async (pageNum, pdf = pdfDocRef.current) => {
    if (!pdf) return;
    
    const page = await pdf.getPage(pageNum);
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const context = canvas.getContext('2d');
    const viewport = page.getViewport({ scale: zoom * 1.5 });
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    
    await page.render({
      canvasContext: context,
      viewport: viewport
    }).promise;
  };

  const changePage = async (direction) => {
    if (isFlipping) return;
    
    let newPage = currentPage;
    if (direction === 'next' && currentPage < totalPages) {
      newPage = currentPage + 1;
      setFlipDirection('next');
    } else if (direction === 'prev' && currentPage > 1) {
      newPage = currentPage - 1;
      setFlipDirection('prev');
    } else {
      return;
    }
    
    setIsFlipping(true);
    playPageFlipSound();
    
    setTimeout(async () => {
      setCurrentPage(newPage);
      await renderPage(newPage);
      setIsFlipping(false);
    }, 600);
  };

  const handleZoom = (direction) => {
    if (direction === 'in' && zoom < 2) {
      const newZoom = zoom + 0.2;
      setZoom(newZoom);
      renderPage(currentPage);
    } else if (direction === 'out' && zoom > 0.6) {
      const newZoom = zoom - 0.2;
      setZoom(newZoom);
      renderPage(currentPage);
    }
  };

  const openExistingPDF = async (pdf) => {
    setCurrentPDF(pdf);
    if (pdf.isLocal && pdf.data) {
      await loadPDFFromData(pdf.data, pdf.title);
    } else {
      await loadPDF(pdf.url);
    }
    setDrawerOpen(false);
  };

  const handleAddPDF = () => {
    if (pdfUrl.trim()) {
      loadPDF(pdfUrl);
      setPdfUrl('');
    }
  };

  const deletePDF = (id) => {
    if (window.confirm('‡¶è‡¶á PDF ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?')) {
      const updatedPDFs = savedPDFs.filter(pdf => pdf.id !== id);
      setSavedPDFs(updatedPDFs);
      localStorage.setItem('pdfLibrary', JSON.stringify(updatedPDFs));
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
      <input
        ref={fileInputRef}
        type="file"
        accept="application/pdf"
        onChange={handleFileUpload}
        className="hidden"
      />

      {loading && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
          <div className="bg-white rounded-lg p-8 text-center">
            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-600 mx-auto mb-4"></div>
            <p className="text-lg font-bold text-gray-800">PDF ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
          </div>
        </div>
      )}
      
      {/* Header */}
      <div className="bg-gradient-to-r from-orange-600 to-red-600 text-white p-4 shadow-lg sticky top-0 z-40">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3">
            <button 
              onClick={() => setDrawerOpen(!drawerOpen)}
              className="p-2 hover:bg-white/20 rounded-lg transition-all"
            >
              <Menu size={24} />
            </button>
            <BookOpen size={32} />
            <h1 className="text-xl md:text-2xl font-bold">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ PDF ‡¶∞‡¶ø‡¶°‡¶æ‡¶∞</h1>
          </div>
          {view === 'reader' && (
            <button 
              onClick={() => setView('home')}
              className="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-lg hover:bg-white/30 transition-all"
            >
              <Home size={20} />
              <span className="hidden md:inline">‡¶π‡ßã‡¶Æ</span>
            </button>
          )}
        </div>
      </div>

      {/* Drawer */}
      <div className={`fixed inset-y-0 left-0 w-80 bg-white shadow-2xl transform transition-transform duration-300 z-50 ${drawerOpen ? 'translate-x-0' : '-translate-x-full'}`}>
        <div className="p-4 border-b border-gray-200 flex justify-between items-center">
          <h2 className="text-xl font-bold text-gray-800">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø</h2>
          <button onClick={() => setDrawerOpen(false)} className="p-2 hover:bg-gray-100 rounded">
            <X size={24} />
          </button>
        </div>
        <div className="p-4 overflow-y-auto h-full pb-20">
          {savedPDFs.length === 0 ? (
            <p className="text-gray-500 text-center mt-10">‡¶ï‡ßã‡¶®‡ßã PDF ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶®‡ßá‡¶á</p>
          ) : (
            <div className="grid grid-cols-2 gap-4">
              {savedPDFs.map((pdf) => (
                <div key={pdf.id} className="relative group">
                  <div 
                    onClick={() => openExistingPDF(pdf)}
                    className="cursor-pointer"
                  >
                    <div className="aspect-[3/4] bg-gradient-to-br from-orange-100 to-red-100 rounded-lg shadow-md group-hover:shadow-xl transition-all border-2 border-orange-200 flex items-center justify-center relative">
                      <BookOpen size={48} className="text-orange-600" />
                      {pdf.isLocal && (
                        <span className="absolute top-2 left-2 text-xs bg-green-500 text-white px-2 py-1 rounded">üì±</span>
                      )}
                    </div>
                    <p className="mt-2 text-sm font-medium text-gray-700 truncate">{pdf.title}</p>
                    <p className="text-xs text-gray-500">{new Date(pdf.addedDate).toLocaleDateString('bn-BD')}</p>
                  </div>
                  <button
                    onClick={(e) => { e.stopPropagation(); deletePDF(pdf.id); }}
                    className="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                  >√ó</button>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Overlay */}
      {drawerOpen && (
        <div 
          className="fixed inset-0 bg-black/50 z-40"
          onClick={() => setDrawerOpen(false)}
        />
      )}

      {/* Main Content */}
      <div className="max-w-7xl mx-auto p-4 md:p-6">
        {view === 'home' && (
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-2xl shadow-2xl p-6 md:p-8 mt-10">
              <div className="text-center mb-8">
                <div className="inline-block p-4 bg-gradient-to-br from-orange-500 to-red-500 rounded-full mb-4">
                  <BookOpen size={48} className="text-white" />
                </div>
                <h2 className="text-2xl md:text-3xl font-bold text-gray-800 mb-2">PDF ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <p className="text-gray-600">‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¶‡¶ø‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</p>
              </div>
              
              <div className="space-y-4">
                <input
                  type="text"
                  value={pdfUrl}
                  onChange={(e) => setPdfUrl(e.target.value)}
                  placeholder="PDF ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®"
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none text-lg"
                  onKeyPress={(e) => e.key === 'Enter' && handleAddPDF()}
                />
                <div className="grid grid-cols-2 gap-4">
                  <button
                    onClick={handleAddPDF}
                    className="bg-gradient-to-r from-orange-600 to-red-600 text-white py-3 rounded-lg font-bold hover:from-orange-700 hover:to-red-700 transition-all shadow-lg flex items-center justify-center gap-2"
                  >
                    <Plus size={20} />
                    ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®
                  </button>
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 rounded-lg font-bold hover:from-green-700 hover:to-emerald-700 transition-all shadow-lg flex items-center justify-center gap-2"
                  >
                    <Upload size={20} />
                    ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
                  </button>
                </div>
              </div>

              <div className="mt-8 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border-2 border-green-200">
                <p className="text-sm text-green-900 font-bold mb-2">‚úÖ ‡¶∏‡ßá‡¶∞‡¶æ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø: ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</p>
                <p className="text-sm text-green-800">
                  ‚Ä¢ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶¨‡¶æ ‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø PDF ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®<br/>
                  ‚Ä¢ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶õ‡¶æ‡¶°‡¶º‡¶æ‡¶á ‡¶™‡¶°‡¶º‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®<br/>
                  ‚Ä¢ ‡ßß‡ß¶‡ß¶% ‡¶¨‡¶á ‡¶è‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶Ö‡¶≠‡¶ø‡¶ú‡ßç‡¶û‡¶§‡¶æ!
                </p>
              </div>

              <div className="mt-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
                <p className="text-sm text-amber-800">
                  üí° <strong>Google Drive ‡¶ü‡¶ø‡¶™‡¶∏:</strong><br/>
                  Share ‚Üí "Anyone with the link" ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá
                </p>
              </div>
            </div>

            {savedPDFs.length > 0 && (
              <div className="mt-10">
                <h3 className="text-xl md:text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                  <BookOpen className="text-orange-600" />
                  ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ PDF ({savedPDFs.length})
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                  {savedPDFs.map((pdf) => (
                    <div 
                      key={pdf.id}
                      onClick={() => openExistingPDF(pdf)}
                      className="cursor-pointer group"
                    >
                      <div className="aspect-[3/4] bg-gradient-to-br from-orange-100 to-red-100 rounded-xl shadow-lg group-hover:shadow-2xl transition-all border-2 border-orange-200 group-hover:border-orange-400 flex items-center justify-center transform group-hover:scale-105 relative">
                        <BookOpen size={48} className="text-orange-600" />
                        {pdf.isLocal && (
                          <span className="absolute top-2 left-2 text-xs bg-green-500 text-white px-2 py-1 rounded shadow">üì±</span>
                        )}
                      </div>
                      <p className="mt-3 text-center font-medium text-gray-700 truncate px-2">{pdf.title}</p>
                      <p className="text-xs text-center text-gray-500">{new Date(pdf.addedDate).toLocaleDateString('bn-BD')}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {view === 'reader' && (
          <div className="bg-white rounded-2xl shadow-2xl p-4 md:p-6">
            {/* Controls */}
            <div className="flex flex-wrap items-center justify-between mb-6 pb-4 border-b border-gray-200 gap-4">
              <div className="flex items-center gap-2 md:gap-4">
                <button
                  onClick={() => changePage('prev')}
                  disabled={currentPage === 1 || isFlipping}
                  className="p-2 md:p-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg hover:from-orange-600 hover:to-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md"
                >
                  <ChevronLeft size={24} />
                </button>
                <span className="text-base md:text-lg font-bold text-gray-700 px-2">
                  ‡¶™‡ßÉ‡¶∑‡ßç‡¶†‡¶æ {currentPage} / {totalPages}
                </span>
                <button
                  onClick={() => changePage('next')}
                  disabled={currentPage === totalPages || isFlipping}
                  className="p-2 md:p-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg hover:from-orange-600 hover:to-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md"
                >
                  <ChevronRight size={24} />
                </button>
              </div>

              <div className="flex items-center gap-2">
                <button
                  onClick={() => handleZoom('out')}
                  className="p-2 md:p-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition-all"
                >
                  <ZoomOut size={20} />
                </button>
                <span className="text-sm font-medium text-gray-600 w-14 text-center">
                  {Math.round(zoom * 100)}%
                </span>
                <button
                  onClick={() => handleZoom('in')}
                  className="p-2 md:p-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition-all"
                >
                  <ZoomIn size={20} />
                </button>
              </div>
            </div>

            {/* PDF Viewer */}
            <div className="relative overflow-auto max-h-[calc(100vh-250px)] bg-gray-100 rounded-lg flex items-center justify-center p-4">
              <canvas 
                ref={canvasRef}
                className={`shadow-2xl max-w-full transition-all duration-600 ${isFlipping ? 'animate-flip' : ''}`}
                style={{ transformStyle: 'preserve-3d' }}
              />
            </div>

            <div className="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
              <p className="text-xs md:text-sm text-amber-800 text-center">
                üìñ <strong>‡¶¨‡¶á ‡¶è‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶™‡¶°‡¶º‡¶æ‡¶∞ ‡¶Ö‡¶≠‡¶ø‡¶ú‡ßç‡¶û‡¶§‡¶æ!</strong> ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶™‡ßá‡¶ú ‡¶â‡¶≤‡ßç‡¶ü‡¶æ‡¶®
              </p>
            </div>
          </div>
        )}
      </div>

      <style jsx>{`
        @keyframes flip {
          0% {
            transform: perspective(1000px) rotateY(0deg);
          }
          50% {
            transform: perspective(1000px) rotateY(90deg);
          }
          100% {
            transform: perspective(1000px) rotateY(0deg);
          }
        }
        .animate-flip {
          animation: flip 0.6s ease-in-out;
        }
      `}</style>
    </div>
  );
};

export default PDFReaderApp;
